<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Payslip Viewer</title>
<style>
  body{font-family:Arial;max-width:900px;margin:30px auto;padding:0 14px}
  label{font-weight:700;display:block;margin-top:14px}
  input,button{width:100%;padding:10px;margin-top:6px;box-sizing:border-box}
  button{margin-top:16px;font-size:16px;cursor:pointer}
  .msg{margin-top:12px;font-weight:700}
  .error{color:#b00020}
  .card{border:1px solid #ddd;border-radius:10px;padding:14px;margin-top:14px}
  .row{display:flex;justify-content:space-between;gap:16px;padding:6px 0;border-bottom:1px dashed #eee}
  .row:last-child{border-bottom:none}
</style>
</head>
<body>

<h2>Payslip Viewer</h2>
<div>Enter your Employee ID and Pay Date to generate your payslip.</div>

<label>Employee ID</label>
<input id="empId" placeholder="e.g. 2025001">

<label>Pay Date</label>
<input id="payDate" type="date">

<button onclick="generate()">Generate Payslip</button>

<div id="msg" class="msg"></div>
<div id="out"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby6aXIILSKJzSe4ML8w3cJVXXhUnTpdupmg-5cyq2quaxI7zXsyimC8Tn-MjiSX4dyL/exec";

function jsonp(baseUrl, params) {
  return new Promise((resolve, reject) => {
    const cbName = "cb_" + Math.random().toString(36).slice(2);
    params.callback = cbName;

    const url = new URL(baseUrl);
    Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));

    const script = document.createElement("script");
    script.src = url.toString();

    window[cbName] = (data) => {
      delete window[cbName];
      script.remove();
      resolve(data);
    };

    script.onerror = () => {
      delete window[cbName];
      script.remove();
      reject(new Error("JSONP failed"));
    };

    document.body.appendChild(script);
  });
}

function section(title, obj) {
  let html = `<div class="card"><h3 style="margin:0 0 10px 0;">${title}</h3>`;
  for (const [k, v] of Object.entries(obj)) {
    html += `<div class="row"><b>${k}</b><span>${v ?? ""}</span></div>`;
  }
  html += `</div>`;
  return html;
}

async function generate() {
  const empId = document.getElementById("empId").value.trim();
  const payDate = document.getElementById("payDate").value;
  const msg = document.getElementById("msg");
  const out = document.getElementById("out");

  msg.textContent = "";
  msg.className = "msg";
  out.innerHTML = "";

  if (!empId || !payDate) {
    msg.textContent = "Please enter Employee ID and Pay Date.";
    msg.className = "msg error";
    return;
  }

  msg.textContent = "Generating...";

  try {
    const data = await jsonp(API_URL, { empId, payDate });

    if (!data.ok) {
      msg.textContent = data.error || "No record found.";
      msg.className = "msg error";
      return;
    }

    msg.textContent = "";
    const r = data.result;

    out.innerHTML =
      section("Employee Information", r.Employee_Information) +
      section("Earnings (Per Payday)", r["Earnings_(Per_Payday)"]) +
      section("Deductions (Employee Share)", r["Deductions_(Employee_Share)"]) +
      section("NET PAY", r["NET_PAY"] || r.NET_PAY) +
      section("Employer Contributions (Company Expense)", r["Employer_Contributions_(Company_Expense)"]);

  } catch (e) {
    msg.textContent = "Cannot connect to payroll system.";
    msg.className = "msg error";
  }
}
</script>

</body>
</html>
